<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cosmograph - 10,000 Node Animation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000000;
        font-family: "Space Mono", monospace;
        overflow: hidden;
      }

      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      #cosmograph {
        width: 100%;
        height: 100%;
      }

      .left-sidebar {
        position: absolute;
        top: 14px;
        left: 14px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 14px;
        width: 196px;
      }

      .simulation-controls {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10.5px 14px;
        border-radius: 7px;
        backdrop-filter: blur(10px);
        box-shadow: 0 5.6px 22.4px rgba(0, 0, 0, 0.3);
      }

      .simulation-controls h3 {
        margin: 0 0 10.5px 0;
        font-size: 12.6px;
        color: #00d4ff;
      }

      .slider-container {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        margin-bottom: 7px;
        gap: 7px;
      }

      .slider-container label {
        grid-column: 1 / 3;
        font-size: 9.8px;
      }

      .slider-container input[type="range"] {
        width: 100%;
        cursor: pointer;
        grid-column: 1 / 2;
        -webkit-appearance: none;
        appearance: none;
        height: 5.6px;
        background: #ddd;
        border-radius: 3.5px;
        outline: none;
      }

      .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 12.6px;
        height: 12.6px;
        background: #00d4ff;
        border-radius: 50%;
        cursor: pointer;
      }

      .slider-container input[type="range"]::-moz-range-thumb {
        width: 12.6px;
        height: 12.6px;
        background: #00d4ff;
        border-radius: 50%;
        cursor: pointer;
      }

      .slider-container span {
        font-weight: bold;
        color: #00d4ff;
        grid-column: 2 / 3;
        min-width: 24.5px;
        text-align: right;
        font-size: 9.8px;
      }

      .toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10.5px;
        padding-top: 10.5px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }

      .toggle-container label {
        font-size: 9.8px;
        color: white;
        font-weight: normal;
      }

      .toggle-container input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .info-panel {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        font-size: 14px;
        line-height: 1.6;
      }

      .info-panel h2 {
        margin: 0 0 10px 0;
        font-size: 18px;
        color: #00d4ff;
      }

      .info-panel p {
        margin: 5px 0;
      }

      .controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .btn {
        background: rgba(0, 212, 255, 0.9);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(0, 212, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
        z-index: 200;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100;
        font-size: 14px;
        min-width: 150px;
      }

      .stat-value {
        color: #00d4ff;
        font-weight: bold;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading Cosmograph...</div>
      </div>

      <div class="left-sidebar">
        <div class="simulation-controls">
          <h3>Simulation Controls</h3>
          <div class="slider-container">
            <label for="spring-slider">Spring</label>
            <input
              type="range"
              id="spring-slider"
              min="0.1"
              max="5"
              step="0.1"
              value="1.0"
            />
            <span id="spring-value">1.0</span>
          </div>
          <div class="slider-container">
            <label for="distance-slider">Distance</label>
            <input
              type="range"
              id="distance-slider"
              min="10"
              max="200"
              step="1"
              value="60"
            />
            <span id="distance-value">60</span>
          </div>
          <div class="slider-container">
            <label for="repulsion-slider">Repulsion</label>
            <input
              type="range"
              id="repulsion-slider"
              min="0.1"
              max="20"
              step="0.1"
              value="8.0"
            />
            <span id="repulsion-value">8.0</span>
          </div>
          <div class="slider-container">
            <label for="gravity-slider">Gravity</label>
            <input
              type="range"
              id="gravity-slider"
              min="0"
              max="5"
              step="0.1"
              value="1.0"
            />
            <span id="gravity-value">1.0</span>
          </div>
          <div class="slider-container">
            <label for="decay-slider">Decay</label>
            <input
              type="range"
              id="decay-slider"
              min="1000"
              max="20000"
              step="500"
              value="10000"
            />
            <span id="decay-value">10000</span>
          </div>
          <div class="toggle-container">
            <label for="show-labels-toggle">Show labels</label>
            <input type="checkbox" id="show-labels-toggle" />
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="fitViewBtn">Fit View</button>
        <button class="btn" id="randomizeBtn">Randomize Colors</button>
      </div>

      <div id="cosmograph"></div>
    </div>

    <script type="module">
      import { Cosmograph } from "@cosmograph/cosmograph";
      let globalNodes = [];

      // Local Storage functions for simulator controls
      const STORAGE_KEY = "cosmograph-simulator-controls";

      function saveControlValues() {
        const values = {
          spring: parseFloat(document.getElementById("spring-slider").value),
          distance: parseInt(document.getElementById("distance-slider").value),
          repulsion: parseFloat(
            document.getElementById("repulsion-slider").value
          ),
          gravity: parseFloat(document.getElementById("gravity-slider").value),
          decay: parseInt(document.getElementById("decay-slider").value),
          showLabels: document.getElementById("show-labels-toggle").checked,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
      }

      function loadControlValues() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            console.warn("Failed to parse saved control values:", e);
          }
        }
        return null;
      }

      function applyControlValues(values) {
        if (!values) return;

        // Apply slider values
        if (values.spring !== undefined) {
          document.getElementById("spring-slider").value = values.spring;
          document.getElementById("spring-value").textContent =
            values.spring.toFixed(1);
        }
        if (values.distance !== undefined) {
          document.getElementById("distance-slider").value = values.distance;
          document.getElementById("distance-value").textContent =
            values.distance;
        }
        if (values.repulsion !== undefined) {
          document.getElementById("repulsion-slider").value = values.repulsion;
          document.getElementById("repulsion-value").textContent =
            values.repulsion.toFixed(1);
        }
        if (values.gravity !== undefined) {
          document.getElementById("gravity-slider").value = values.gravity;
          document.getElementById("gravity-value").textContent =
            values.gravity.toFixed(1);
        }
        if (values.decay !== undefined) {
          document.getElementById("decay-slider").value = values.decay;
          document.getElementById("decay-value").textContent = values.decay;
        }
        if (values.showLabels !== undefined) {
          document.getElementById("show-labels-toggle").checked =
            values.showLabels;
        }
      }

      let config = {
        backgroundColor: "rgba(0, 0, 0, 0.95)",
        nodeColor: (node) => node.color,
        nodeSize: (node) => node.size,
        linkColor: () => `rgba(255, 255, 255, 0.3)`,
        linkWidth: (link) => {
          // Make links to/from node_0 invisible (0 width)
          if (link.source === "node_0" || link.target === "node_0") {
            return 0;
          }
          // All other links are visible
          return 2.0;
        },

        // Beautiful animation settings
        disableSimulation: false, // Explicitly enable simulation
        // simulationFriction: 10, // Less friction for more movement

        // Step 1: Test with simple static values first
        simulationLinkSpring: 1.0, // Single value for all links
        simulationLinkDistance: 60, // Single value for all links

        simulationRepulsion: 8.0, // Very strong repulsion for explosion effect
        simulationGravity: 1.0, // Minimal gravity
        // simulationCenter: 0, // Minimal centering force
        simulationDecay: 10000, // Much longer simulation time

        // // Visual enhancements
        // curvedLinks: false,
        // curvedLinkWeight: 0.6,
        linkArrows: false,
        // scaleNodesOnZoom: true,
        // pixelRatio: 2,
        nodeGreyoutOpacity: 0.2,

        // Labels
        showDynamicLabels: false,
        showLabelsFor: [{ id: "ROOT" }],

        // // Zoom settings
        fitViewOnInit: false,
        // fitViewDelay: 500,
        initialZoomLevel: 0.5,

        // // Performance
        // showFPSMonitor: false,
        // spaceSize: 6000,
        onClick: (node, index, position, event) => {
          if (node) {
            console.log("Selected node:", node);
            cosmograph.selectNode(node, true); // Select node and adjacent nodes
            cosmograph.zoomToNode(node); // Zoom to the selected node
            config.showLabelsFor = [node];
            cosmograph.setConfig(config);
          } else {
            console.log("Deselected node");
            cosmograph.unselectNodes();
            config.showLabelsFor = [];
            cosmograph.setConfig(config);
          }
        }, // onClick
      };

      async function loadDataFromCSV(url) {
        const response = await fetch(url);
        const csvText = await response.text();
        const lines = csvText.trim().split("\n");
        lines.shift(); // Remove header

        const nodes = [];
        const links = [];
        const nodeMap = new Map();
        const linkSet = new Set();

        lines.forEach((line) => {
          const [domainName, clusterName, nodeName] = line
            .split(",")
            .map((s) => s.trim().replace(/^"|"$/g, ""));
          if (!domainName || !clusterName || !nodeName) return;

          // Create Domain node if it doesn't exist
          const domainId = `Domain:${domainName}`;
          if (!nodeMap.has(domainId)) {
            nodeMap.set(domainId, {
              id: domainId,
              name: domainName,
              type: "Domain",
              size: 12,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(domainId));
          }

          // Create Cluster node if it doesn't exist
          const clusterId = `Cluster:${clusterName}`;
          if (!nodeMap.has(clusterId)) {
            nodeMap.set(clusterId, {
              id: clusterId,
              name: clusterName,
              type: "Cluster",
              size: 8,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(clusterId));
          }

          // Create Node node if it doesn't exist
          const nodeId = `Node:${nodeName}`;
          if (!nodeMap.has(nodeId)) {
            nodeMap.set(nodeId, {
              id: nodeId,
              name: nodeName,
              type: "Node",
              size: 4,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(nodeId));
          }

          // Add links
          const domainClusterLink = `${domainId}-${clusterId}`;
          if (!linkSet.has(domainClusterLink)) {
            links.push({ source: domainId, target: clusterId });
            linkSet.add(domainClusterLink);
          }
          const clusterNodeLink = `${clusterId}-${nodeId}`;
          if (!linkSet.has(clusterNodeLink)) {
            links.push({ source: clusterId, target: nodeId });
            linkSet.add(clusterNodeLink);
          }
        });

        // Create ROOT node and connect to all domains
        const rootId = "ROOT";
        nodeMap.set(rootId, {
          id: rootId,
          name: "ROOT",
          type: "ROOT",
          size: 16,
          color: "rgba(0, 212, 255, 0.5)",
        });
        nodes.push(nodeMap.get(rootId));

        const domainNodes = nodes.filter((n) => n.type === "Domain");
        domainNodes.forEach((domainNode) => {
          const rootDomainLink = `${rootId}-${domainNode.id}`;
          if (!linkSet.has(rootDomainLink)) {
            links.push({ source: rootId, target: domainNode.id });
            linkSet.add(rootDomainLink);
          }
        });

        console.log(
          `Loaded ${nodes.length} nodes and ${links.length} links from CSV.`
        );
        return { nodes, links };
      }

      // Create container element
      const container = document.getElementById("cosmograph");

      // Initialize Cosmograph with simple settings
      const cosmograph = new Cosmograph(container, config);

      // Set up event handlers
      let isRunning = true;
      let animationFrame;

      cosmograph.onNodeMouseOver = (node) => {
        // Add a subtle glow effect by temporarily changing the node
        if (node) {
          console.log("Hovering:", node.category, node.id);
        }
      };

      cosmograph.onSimulationTick = (alpha) => {
        const progress = Math.round((1 - alpha) * 100);
        document.getElementById("progress").textContent = `${progress}%`;
      };

      cosmograph.onZoom = (event) => {
        const zoom = parseFloat(event.transform.k.toFixed(2));
        document.getElementById("zoomLevel").textContent = zoom.toString();
      };

      // Control buttons
      document.getElementById("pauseBtn").addEventListener("click", () => {
        if (isRunning) {
          cosmograph.pause();
          document.getElementById("pauseBtn").textContent = "Resume";
          isRunning = false;
        } else {
          cosmograph.restart();
          document.getElementById("pauseBtn").textContent = "Pause";
          isRunning = true;
        }
      });

      document.getElementById("restartBtn").addEventListener("click", () => {
        cosmograph.start(1.0);
        document.getElementById("pauseBtn").textContent = "Pause";
        isRunning = true;
      });

      document.getElementById("fitViewBtn").addEventListener("click", () => {
        cosmograph.fitView(1000);
      });

      document.getElementById("randomizeBtn").addEventListener("click", () => {
        const selectedNodes = cosmograph.getSelectedNodes();
        currentScheme = (currentScheme + 1) % schemes.length;
        const schemeName = schemes[currentScheme];
        const colorFunc = colorSchemes[schemeName];

        // Update node colors
        nodes.forEach((node, i) => {
          node.color = colorFunc(i, nodes.length);
        });

        // Update the cosmograph
        cosmograph.setData(nodes, links);
        if (selectedNodes.length > 0) {
          cosmograph.selectNodes(selectedNodes);
        }
        config.nodeColor = (node) => node.color;
        cosmograph.setConfig(config);

        console.log(`Applied ${schemeName} color scheme`);
      });

      // Simulation control sliders
      document
        .getElementById("spring-slider")
        .addEventListener("input", (e) => {
          const value = parseFloat(e.target.value);
          document.getElementById("spring-value").textContent =
            value.toFixed(1);
          config.simulationLinkSpring = value;
          cosmograph.setConfig(config);
          saveControlValues();
        });

      document
        .getElementById("distance-slider")
        .addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          document.getElementById("distance-value").textContent = value;
          config.simulationLinkDistance = value;
          cosmograph.setConfig(config);
          saveControlValues();
        });

      document
        .getElementById("repulsion-slider")
        .addEventListener("input", (e) => {
          const value = parseFloat(e.target.value);
          document.getElementById("repulsion-value").textContent =
            value.toFixed(1);
          config.simulationRepulsion = value;
          cosmograph.setConfig(config);
          saveControlValues();
        });

      document
        .getElementById("gravity-slider")
        .addEventListener("input", (e) => {
          const value = parseFloat(e.target.value);
          document.getElementById("gravity-value").textContent =
            value.toFixed(1);
          config.simulationGravity = value;
          cosmograph.setConfig(config);
          saveControlValues();
        });

      document.getElementById("decay-slider").addEventListener("input", (e) => {
        const value = parseInt(e.target.value);
        document.getElementById("decay-value").textContent = value;
        config.simulationDecay = value;
        cosmograph.setConfig(config);
        saveControlValues();
      });

      // Show labels toggle
      document
        .getElementById("show-labels-toggle")
        .addEventListener("change", (e) => {
          const showAllLabels = e.target.checked;
          if (showAllLabels) {
            // Show all node labels
            config.showLabelsFor = globalNodes;
            cosmograph.setConfig(config);
          } else {
            // Show only Domain node labels
            config.showLabelsFor = globalNodes.filter(
              (n) => n.type === "Domain"
            );
            cosmograph.setConfig(config);
          }
          saveControlValues();
        });

      // FPS counter
      let lastTime = performance.now();
      let frameCount = 0;

      function updateFPS() {
        frameCount++;
        const now = performance.now();
        const delta = now - lastTime;

        if (delta >= 1000) {
          const fps = Math.round((frameCount * 1000) / delta);
          document.getElementById("fps").textContent = fps.toString();
          frameCount = 0;
          lastTime = now;
        }

        requestAnimationFrame(updateFPS);
      }

      // Initialize the graph
      async function init() {
        try {
          // Load and apply saved control values first
          const savedValues = loadControlValues();
          applyControlValues(savedValues);

          console.log("Setting data...");
          const { nodes, links } = await loadDataFromCSV("nodes.csv");
          globalNodes = nodes;
          cosmograph.setData(nodes, links);

          // Apply saved values to cosmograph config if they exist
          if (savedValues) {
            if (savedValues.spring !== undefined)
              config.simulationLinkSpring = savedValues.spring;
            if (savedValues.distance !== undefined)
              config.simulationLinkDistance = savedValues.distance;
            if (savedValues.repulsion !== undefined)
              config.simulationRepulsion = savedValues.repulsion;
            if (savedValues.gravity !== undefined)
              config.simulationGravity = savedValues.gravity;
            if (savedValues.decay !== undefined)
              config.simulationDecay = savedValues.decay;

            // Handle labels based on saved checkbox state
            if (savedValues.showLabels) {
              config.showLabelsFor = globalNodes;
            } else {
              config.showLabelsFor = globalNodes.filter(
                (n) => n.type === "Domain"
              );
            }
          } else {
            // Default behavior when no saved values
            config.showLabelsFor = globalNodes.filter(
              (n) => n.type === "Domain"
            );
          }

          cosmograph.setConfig(config);

          // Explicitly start simulation with high energy for the "explosion" effect
          console.log("Starting simulation with high energy...");

          // Hide loading indicator
          document.getElementById("loading").style.display = "none";

          console.log("Cosmograph initialized successfully!");
          console.log("Controls:");
          console.log("- Click nodes to select and zoom");
          console.log("- Use mouse wheel to zoom");
          console.log("- Drag to pan");
          console.log("- Use control buttons for interactions");

          // Start FPS monitoring
          updateFPS();
        } catch (error) {
          console.error("Error initializing Cosmograph:", error);
          document.getElementById("loading").innerHTML = `
                    <div style="color: #ff4444;">
                        <div>Failed to load Cosmograph</div>
                        <div style="font-size: 14px; margin-top: 10px;">${error.message}</div>
                    </div>
                `;
        }
      }

      // Wait a moment for the library to load, then initialize
      setTimeout(init, 100);
    </script>
  </body>
</html>
