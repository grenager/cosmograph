<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cosmograph - 10,000 Node Animation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000000;
        font-family: "Space Mono", monospace;
        overflow: hidden;
      }

      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      #cosmograph {
        width: 100%;
        height: 100%;
      }

      .info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100;
        font-size: 14px;
        line-height: 1.6;
      }

      .info-panel h2 {
        margin: 0 0 10px 0;
        font-size: 18px;
        color: #00d4ff;
      }

      .info-panel p {
        margin: 5px 0;
      }

      .controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .btn {
        background: rgba(0, 212, 255, 0.9);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(0, 212, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
        z-index: 200;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100;
        font-size: 14px;
        min-width: 150px;
      }

      .stat-value {
        color: #00d4ff;
        font-weight: bold;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading Cosmograph...</div>
      </div>

      <div class="info-panel">
        <h2>ðŸŒŒ Cosmic Network</h2>
        <p><strong>Nodes:</strong> 1000 particles</p>
        <p><strong>Links:</strong> Dynamic connections</p>
        <p><strong>Colors:</strong> Rainbow spectrum</p>
        <p><strong>Animation:</strong> Real-time physics</p>
      </div>

      <div class="stats" id="stats">
        <div>Zoom: <span class="stat-value" id="zoomLevel">1.0</span></div>
        <div>FPS: <span class="stat-value" id="fps">60</span></div>
        <div>Progress: <span class="stat-value" id="progress">0%</span></div>
      </div>

      <div class="controls">
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="fitViewBtn">Fit View</button>
        <button class="btn" id="randomizeBtn">Randomize Colors</button>
      </div>

      <div id="cosmograph"></div>
    </div>

    <script type="module">
      import { Cosmograph } from "@cosmograph/cosmograph";

      async function loadDataFromCSV(url) {
        const response = await fetch(url);
        const csvText = await response.text();
        const lines = csvText.trim().split("\n");
        lines.shift(); // Remove header

        const nodes = [];
        const links = [];
        const nodeMap = new Map();

        lines.forEach((line) => {
          const [domainName, clusterName, nodeName] = line
            .split(",")
            .map((s) => s.trim().replace(/^"|"$/g, ""));
          if (!domainName || !clusterName || !nodeName) return;

          // Create Domain node if it doesn't exist
          const domainId = `Domain:${domainName}`;
          if (!nodeMap.has(domainId)) {
            nodeMap.set(domainId, {
              id: domainId,
              name: domainName,
              type: "Domain",
              size: 12,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(domainId));
          }

          // Create Cluster node if it doesn't exist
          const clusterId = `Cluster:${clusterName}`;
          if (!nodeMap.has(clusterId)) {
            nodeMap.set(clusterId, {
              id: clusterId,
              name: clusterName,
              type: "Cluster",
              size: 8,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(clusterId));
          }

          // Create Node node if it doesn't exist
          const nodeId = `Node:${nodeName}`;
          if (!nodeMap.has(nodeId)) {
            nodeMap.set(nodeId, {
              id: nodeId,
              name: nodeName,
              type: "Node",
              size: 4,
              color: "rgba(0, 212, 255, 0.5)",
            });
            nodes.push(nodeMap.get(nodeId));
          }

          // Add links
          links.push({ source: domainId, target: clusterId });
          links.push({ source: clusterId, target: nodeId });
        });

        // Create ROOT node and connect to all domains
        const rootId = "ROOT";
        nodeMap.set(rootId, {
          id: rootId,
          name: "ROOT",
          type: "ROOT",
          size: 16,
          color: "rgba(0, 212, 255, 0.5)",
        });
        nodes.push(nodeMap.get(rootId));

        const domainNodes = nodes.filter((n) => n.type === "Domain");
        domainNodes.forEach((domainNode) => {
          links.push({ source: rootId, target: domainNode.id });
        });

        console.log(
          `Loaded ${nodes.length} nodes and ${links.length} links from CSV.`
        );
        return { nodes, links };
      }

      // Create container element
      const container = document.getElementById("cosmograph");

      // Initialize Cosmograph with simple settings
      const cosmograph = new Cosmograph(container, {
        backgroundColor: "rgba(0, 0, 0, 0.95)",
        nodeColor: (node) => node.color,
        nodeSize: (node) => node.size,
        linkColor: () => `rgba(255, 255, 255, 0.1)`,
        linkWidth: (link) => {
          // Make links to/from node_0 invisible (0 width)
          if (link.source === "node_0" || link.target === "node_0") {
            return 0;
          }
          // All other links are visible
          return 2.0;
        },

        // Beautiful animation settings
        disableSimulation: false, // Explicitly enable simulation
        // simulationFriction: 10, // Less friction for more movement

        // Step 1: Test with simple static values first
        simulationLinkSpring: 1.0, // Single value for all links
        simulationLinkDistance: 50, // Single value for all links

        simulationRepulsion: 1.0, // Very strong repulsion for explosion effect
        // simulationGravity: 0.005, // Minimal gravity
        // simulationCenter: 0, // Minimal centering force
        simulationDecay: 10000, // Much longer simulation time

        // // Visual enhancements
        // curvedLinks: false,
        // curvedLinkWeight: 0.6,
        linkArrows: false,
        // scaleNodesOnZoom: true,
        // pixelRatio: 2,

        // // Labels
        // showDynamicLabels: false,
        // showTopLabels: false,
        // showHoveredNodeLabel: true,
        // nodeLabelAccessor: (node) =>
        //   `${node.category} ${node.id.split("_")[1]}`,

        // // Zoom settings
        fitViewOnInit: false,
        // fitViewDelay: 500,
        initialZoomLevel: 0.5,

        // // Performance
        // showFPSMonitor: false,
        // spaceSize: 6000,
      });

      // Set up event handlers
      let isRunning = true;
      let animationFrame;

      cosmograph.onClick = (node, index, position, event) => {
        if (node) {
          console.log("Clicked node:", node);
          cosmograph.selectNode(node, true); // Select node and adjacent nodes
          cosmograph.zoomToNode(node);
        }
      };

      cosmograph.onNodeMouseOver = (node) => {
        // Add a subtle glow effect by temporarily changing the node
        if (node) {
          console.log("Hovering:", node.category, node.id);
        }
      };

      cosmograph.onSimulationTick = (alpha) => {
        const progress = Math.round((1 - alpha) * 100);
        document.getElementById("progress").textContent = `${progress}%`;
      };

      cosmograph.onZoom = (event) => {
        const zoom = parseFloat(event.transform.k.toFixed(2));
        document.getElementById("zoomLevel").textContent = zoom.toString();
      };

      // Control buttons
      document.getElementById("pauseBtn").addEventListener("click", () => {
        if (isRunning) {
          cosmograph.pause();
          document.getElementById("pauseBtn").textContent = "Resume";
          isRunning = false;
        } else {
          cosmograph.restart();
          document.getElementById("pauseBtn").textContent = "Pause";
          isRunning = true;
        }
      });

      document.getElementById("restartBtn").addEventListener("click", () => {
        cosmograph.start(1.0);
        document.getElementById("pauseBtn").textContent = "Pause";
        isRunning = true;
      });

      document.getElementById("fitViewBtn").addEventListener("click", () => {
        cosmograph.fitView(1000);
      });

      document.getElementById("randomizeBtn").addEventListener("click", () => {
        currentScheme = (currentScheme + 1) % schemes.length;
        const schemeName = schemes[currentScheme];
        const colorFunc = colorSchemes[schemeName];

        // Update node colors
        nodes.forEach((node, i) => {
          node.color = colorFunc(i, nodes.length);
        });

        // Update the cosmograph
        cosmograph.setData(nodes, links);
        cosmograph.setConfig({
          nodeColor: (node) => node.color,
        });

        console.log(`Applied ${schemeName} color scheme`);
      });

      // FPS counter
      let lastTime = performance.now();
      let frameCount = 0;

      function updateFPS() {
        frameCount++;
        const now = performance.now();
        const delta = now - lastTime;

        if (delta >= 1000) {
          const fps = Math.round((frameCount * 1000) / delta);
          document.getElementById("fps").textContent = fps.toString();
          frameCount = 0;
          lastTime = now;
        }

        requestAnimationFrame(updateFPS);
      }

      // Initialize the graph
      async function init() {
        try {
          console.log("Setting data...");
          const { nodes, links } = await loadDataFromCSV("nodes.csv");
          cosmograph.setData(nodes, links);

          // Explicitly start simulation with high energy for the "explosion" effect
          console.log("Starting simulation with high energy...");

          // Hide loading indicator
          document.getElementById("loading").style.display = "none";

          console.log("Cosmograph initialized successfully!");
          console.log("Controls:");
          console.log("- Click nodes to select and zoom");
          console.log("- Use mouse wheel to zoom");
          console.log("- Drag to pan");
          console.log("- Use control buttons for interactions");

          // Start FPS monitoring
          updateFPS();
        } catch (error) {
          console.error("Error initializing Cosmograph:", error);
          document.getElementById("loading").innerHTML = `
                    <div style="color: #ff4444;">
                        <div>Failed to load Cosmograph</div>
                        <div style="font-size: 14px; margin-top: 10px;">${error.message}</div>
                    </div>
                `;
        }
      }

      // Wait a moment for the library to load, then initialize
      setTimeout(init, 100);

      // Add some interactive features
      let colorAnimationInterval;

      // Animate colors over time (optional - can be toggled)
      function startColorAnimation() {
        colorAnimationInterval = setInterval(() => {
          nodes.forEach((node, i) => {
            const time = Date.now() * 0.001;
            const hue = ((i / nodes.length) * 360 + time * 10) % 360;
            node.color = `hsl(${hue}, 70%, ${
              50 + Math.sin(time + i * 0.01) * 20
            }%)`;
          });

          cosmograph.setConfig({
            nodeColor: (node) => node.color,
          });
        }, 100);
      }

      // Add keyboard controls
      document.addEventListener("keydown", (e) => {
        switch (e.code) {
          case "Space":
            e.preventDefault();
            document.getElementById("pauseBtn").click();
            break;
          case "KeyR":
            document.getElementById("restartBtn").click();
            break;
          case "KeyF":
            document.getElementById("fitViewBtn").click();
            break;
          case "KeyC":
            document.getElementById("randomizeBtn").click();
            break;
        }
      });

      console.log("ðŸŒŒ Cosmic Network initialized!");
      console.log("Keyboard shortcuts:");
      console.log("  Space - Pause/Resume");
      console.log("  R - Restart simulation");
      console.log("  F - Fit view");
      console.log("  C - Change color scheme");
    </script>
  </body>
</html>
